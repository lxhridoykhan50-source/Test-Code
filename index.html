<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Messenger Pro</title>

<style>
  * {box-sizing:border-box;}
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #3b82f6, #9333ea);
    min-height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .box {
    width: 90%;
    max-width: 420px;
    padding: 25px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    color: #fff;
    animation: fadeIn 0.7s ease;
    position: relative;
  }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
  h2 { text-align:center; color:#fff; margin-bottom:20px; font-weight:600; }
  input, button { font-size:16px; border-radius:8px; border:none; outline:none; transition:all 0.3s ease; }
  input {
    width:100%; padding:12px; background:rgba(255,255,255,0.2);
    color:#fff; border:1px solid rgba(255,255,255,0.3); margin-bottom:10px;
  }
  input::placeholder {color:#e5e7eb;}
  input:focus { background:rgba(255,255,255,0.3); border-color:#60a5fa; }
  button { width:100%; padding:12px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
  button:hover {background:#1d4ed8;}

  .chatHeader {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    padding: 10px 15px;
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }
  .chatHeader h2 { margin: 0; font-size: 18px; color: #fff; }
  .logoutBtn {
    background: #ef4444; color: #fff; border: none; border-radius: 8px;
    padding: 8px 12px; font-weight: 600; cursor: pointer; transition: 0.3s;
  }
  .logoutBtn:hover { background: #dc2626; transform: scale(1.05); }

  .messages {
    height:300px; overflow-y:auto; padding:12px;
    background:rgba(255,255,255,0.1); border-radius:10px;
    backdrop-filter:blur(10px); scroll-behavior:smooth;
  }
  .msg {
    margin:10px 0; padding:10px 14px; border-radius:14px;
    max-width:80%; position:relative; animation: slideIn 0.3s ease;
    word-wrap: break-word;
  }
  @keyframes slideIn { from {transform: translateY(10px); opacity:0;} to {transform: translateY(0); opacity:1;} }
  .me { background:#2563eb; color:#fff; margin-left:auto; border-bottom-right-radius:0; }
  .other { background:rgba(255,255,255,0.25); color:#fff; margin-right:auto; border-bottom-left-radius:0; }
  .time { font-size:11px; opacity:0.8; margin-top:4px; text-align:right; }

  .sendArea { display:flex; margin-top:12px; gap:6px; }
  .sendArea input { flex:1; border:none; padding:10px; }
  .sendBtn {
    background:#60a5fa; border:none; border-radius:8px;
    width:48px; cursor:pointer; transition:0.3s;
  }
  .sendBtn:hover {background:#3b82f6;}

  .online-box {
    background:rgba(255,255,255,0.15); padding:10px;
    border-radius:10px; margin-bottom:10px;
  }

  .typing { font-size:13px; color:#22c55e; margin-top:6px; text-align:center; }

  .contextMenu {
    position: absolute; background: rgba(0,0,0,0.9);
    color: #fff; border-radius: 8px; padding: 5px 0;
    z-index: 9999; display:none; min-width: 120px;
  }
  .contextMenu button { width:100%; padding:6px 10px; border:none; background:none; color:#fff; cursor:pointer; text-align:left; }
  .contextMenu button:hover { background: rgba(255,255,255,0.1); }
</style>
</head>

<body>

<!-- üîê Secret Code -->
<div id="codeBox" class="box">
  <h2>üîê Secret Access</h2>
  <input type="password" id="secretCode" placeholder="‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
  <button onclick="checkCode()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<!-- üë§ Name Box -->
<div id="nameBox" class="box" style="display:none;">
  <h2>üë§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</h2>
  <input type="text" id="userName" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®‡¶É example">
  <button onclick="setName()">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<!-- üí¨ Chat Box -->
<div id="chatBox" class="box" style="display:none;">
  <div class="chatHeader">
    <h2>üí¨ Smart Messenger</h2>
    <button class="logoutBtn" onclick="logout()">üö™ Logout</button>
  </div>

  <div class="online-box">
    <b>üü¢ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá:</b>
    <ul id="onlineUsers" style="list-style:none; padding:0; margin:5px 0 0;"></ul>
  </div>

  <div class="messages" id="messages"></div>
  <div class="typing" id="typingText"></div>

  <div class="sendArea">
    <input type="text" id="msgInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="userTyping()">
    <button class="sendBtn" onclick="sendMsg()">üì®</button>
  </div>
</div>

<!-- Context Menu -->
<div class="contextMenu" id="contextMenu">
  <button onclick="editMessage()">Edit Message</button>
  <button onclick="replyMessage()">Reply</button>
  <button onclick="deleteOwnMessage()">Delete Message</button>
</div>

<audio id="notifySound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_ef6a2a3b59.mp3?filename=notification-1-126517.mp3"></audio>

<script type="module">

/* ========== FIREBASE IMPORT =========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, set, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ========== FIREBASE CONFIG =========== */
const firebaseConfig = {
  apiKey: "AIzaSyDI5sQSiaX71auqXzZeVo_qAg_FKi6ZJLY",
  authDomain: "my-app-a1e05.firebaseapp.com",
  databaseURL: "https://my-app-a1e05-default-rtdb.firebaseio.com",
  projectId: "my-app-a1e05",
  storageBucket: "my-app-a1e05.firebasestorage.app",
  messagingSenderId: "976679185393",
  appId: "1:976679185393:web:c018991df3bf87d48ab250",
  measurementId: "G-8RFBTMQJLX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========= GLOBAL VARS ========= */
const SECRET = "199234";
const codeBox = document.getElementById("codeBox");
const nameBox = document.getElementById("nameBox");
const chatBox = document.getElementById("chatBox");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sound = document.getElementById("notifySound");
const typingText = document.getElementById("typingText");
const onlineList = document.getElementById("onlineUsers");
const contextMenu = document.getElementById("contextMenu");

let user = localStorage.getItem("smartUser") || "";
let typingTimeout;
let lastMsgCount = 0;
const ADMIN = "Admin";

let selectedMsgKey = "";
let selectedMsgData = null;

/* ========= AUTO LOGIN ========= */
if (user) {
  codeBox.style.display="none";
  chatBox.style.display="block";
  setOnline(user);
  loadMessages();
  showOnlineUsers();
  watchTyping();
}

/* ========= CHECK CODE ========= */
window.checkCode = () => {
  const code = document.getElementById("secretCode").value.trim();
  if(code === SECRET){
    codeBox.style.display="none";
    nameBox.style.display="block";
  } else alert("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶ï‡ßã‡¶°!");
};

/* ========= SET NAME ========= */
window.setName = () => {
  const name = document.getElementById("userName").value.trim();
  if(!name) return alert("‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
  user = name;
  localStorage.setItem("smartUser", name);
  nameBox.style.display="none";
  chatBox.style.display="block";
  setOnline(user);
  loadMessages();
  showOnlineUsers();
  watchTyping();
};

/* ========== SEND MESSAGE (FIXED REPLY) ========== */
window.sendMsg = async () => {
  const text = msgInput.value.trim();
  if(!text) return;

  await push(ref(db, "messages"), {
    user,
    text,
    time: new Date().toLocaleTimeString(),
    createdAt: serverTimestamp(),

    /* ‚≠ê Reply message ‡¶è‡¶ñ‡¶® ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá */
    reply: selectedMsgKey ? {
      key: selectedMsgKey,
      user: selectedMsgData.user,
      text: selectedMsgData.text
    } : null
  });

  msgInput.value="";
  selectedMsgKey = "";
  selectedMsgData = null;
  update(ref(db, "typing/"+user), {typing:false});
};

/* ========= USER TYPING ========= */
window.userTyping = () => {
  update(ref(db, "typing/"+user), {typing:true});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>update(ref(db,"typing/"+user),{typing:false}),2000);
};

/* ========= WATCH TYPING ========= */
function watchTyping(){
  onValue(ref(db,"typing"), snap => {
    let txt="";
    snap.forEach(c=>{
      const d=c.val();
      if(d.typing && c.key!==user) txt=`‚úçÔ∏è ${c.key} ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡¶õ‡ßá...`;
    });
    typingText.innerText=txt;
  });
}

/* ========== LOAD MESSAGES (REPLY FIXED) ========== */
function loadMessages(){
  onValue(ref(db,"messages"), snap => {

    const total = snap.size;
    if(total > lastMsgCount && lastMsgCount !== 0) sound.play();
    lastMsgCount = total;

    messages.innerHTML="";

    snap.forEach(child => {
      const key = child.key;
      const d = child.val();

      /* ========== NORMAL BUBBLE ========== */
      const div = document.createElement("div");
      div.classList.add("msg");
      div.classList.add(d.user === user ? "me" : "other");
      div.dataset.key = key;

      /* ‚≠ê Reply preview (WhatsApp style) */
      let replyPreview = "";
      if(d.reply){
        replyPreview = `
          <div style="font-size:12px; opacity:0.8; border-left:3px solid #fff; padding-left:6px; margin-bottom:4px;">
            <b>${d.reply.user}</b>: ${d.reply.text}
          </div>
        `;
      }

      div.innerHTML = `
        ${replyPreview}
        <div><b>${d.user}:</b> ${d.text}</div>
        <div class="time">${d.time||""}</div>
      `;

      /* ‚Ü≥ Context Menu */
      div.addEventListener("contextmenu", e=>{
        e.preventDefault();
        selectedMsgKey = key;
        selectedMsgData = d;

        if(d.user === user){
          contextMenu.innerHTML = `
            <button onclick="editMessage()">Edit Message</button>
            <button onclick="replyMessage()">Reply</button>
            <button onclick="deleteOwnMessage()">Delete Message</button>
          `;
        } else {
          contextMenu.innerHTML = `
            <button onclick="replyMessage()">Reply</button>
          `;
        }

        contextMenu.style.left = e.pageX+"px";
        contextMenu.style.top = e.pageY+"px";
        contextMenu.style.display = "block";
      });

      messages.appendChild(div);

      /* ADMIN DELETE BUTTON */
      if(user===ADMIN){
        const del=document.createElement("button");
        del.innerText="√ó";
        del.style.cssText=`
          position:absolute; top:-8px; right:-8px;
          background:#ef4444; color:#fff; border:none;
          border-radius:50%; width:20px; height:20px; cursor:pointer;
        `;
        del.onclick=()=>deleteMsg(key);
        div.appendChild(del);
      }
    });

    messages.scrollTop = messages.scrollHeight;
  });
}

/* ========= ONLINE LIST ========= */
function setOnline(name){
  const userRef=ref(db,"online/"+name);
  set(userRef,{online:true,lastSeen:serverTimestamp()});
  window.addEventListener("beforeunload",()=>remove(userRef));
}

function showOnlineUsers(){
  onValue(ref(db,"online"), snap=>{
    onlineList.innerHTML="";
    snap.forEach(child=>{
      onlineList.innerHTML+=`<li>üü¢ ${child.key}</li>`;
    });
  });
}

/* ========= LOGOUT ========= */
window.logout = ()=>{
  localStorage.removeItem("smartUser");
  remove(ref(db,"online/"+user));
  chatBox.style.display="none";
  nameBox.style.display="none";
  codeBox.style.display="block";
  document.getElementById("secretCode").value="";
  user="";
};

/* ========= CONTEXT MENU ACTIONS ========= */
window.onclick = ()=> contextMenu.style.display = "none";

window.editMessage = ()=>{
  if(selectedMsgKey && selectedMsgData){
    const newText = prompt("Edit your message:", selectedMsgData.text);
    if(newText) update(ref(db,"messages/"+selectedMsgKey), {text:newText});
  }
  contextMenu.style.display = "none";
};

window.replyMessage = ()=>{
  msgInput.value = "";
  if(selectedMsgKey && selectedMsgData){
    msgInput.focus();
  }
  contextMenu.style.display = "none";
};

window.deleteOwnMessage = ()=>{
  if(selectedMsgKey && selectedMsgData && selectedMsgData.user===user){
    if(confirm("üóëÔ∏è ‡¶è‡¶á ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")){
      remove(ref(db,"messages/"+selectedMsgKey));
    }
  }
  contextMenu.style.display = "none";
};

window.deleteMsg = async (id)=>{
  if(user!==ADMIN) return;
  if(confirm("üóëÔ∏è ‡¶è‡¶á ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")){
    await remove(ref(db,"messages/"+id));
  }
};

</script>
</body>
</html>
