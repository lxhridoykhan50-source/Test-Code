<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Premium Ads Income</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="//libtl.com/sdk.js" data-zone="9777736" data-sdk="show_9777736"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, set, get, child, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbbvEUnjEnbOPtZJyqL-CUEDy_nAZtGT4",
  authDomain: "hridoy-f9c90.firebaseapp.com",
  databaseURL: "https://hridoy-f9c90-default-rtdb.firebaseio.com",
  projectId: "hridoy-f9c90",
  storageBucket: "hridoy-f9c90.firebasestorage.app",
  messagingSenderId: "378490678321",
  appId: "1:378490678321:web:623f8de0c24dda4dfdb910",
  measurementId: "G-5X6Z7BWTFY"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
const userName = tg?.initDataUnsafe?.user?.first_name || "Unknown";
const userId = tg?.initDataUnsafe?.user?.id || "unknown_user";
const photoUrl = tg?.initDataUnsafe?.user?.photo_url || "https://telegram.org/img/t_logo.png";

// üîπ Helper function: Generate unique referral code
function generateReferralCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "REF";
  for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
  return code;
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("user-name").innerText = userName;
  document.getElementById("user-photo").src = photoUrl;
  updateUI();
});

const REWARD = 5;
const MIN_WITHDRAW = 2000;
const REF_BONUS = 50;
const MIN_REF_FOR_WITHDRAW = 10;
const AD_DURATION = 15;
let adTimer = null;

// üîπ Get or Create User Data
async function getUserData() {
  const dbRef = ref(db);
  const snapshot = await get(child(dbRef, `users/${userId}`));
  if (snapshot.exists()) {
    const data = snapshot.val();
    if (!data.claimedReferrals) data.claimedReferrals = [];
    if (!data.balance) data.balance = 0;
    if (!data.views) data.views = 0;
    if (!data.refCount) data.refCount = 0;
    if (!data.totalWithdrawn) data.totalWithdrawn = 0;
    if (!data.referralCode) {
      data.referralCode = generateReferralCode();
      await saveUserData(data);
    }
    return data;
  } else {
    const defaultData = {
      balance: 0,
      views: 0,
      refCount: 0,
      totalWithdrawn: 0,
      claimedReferrals: [],
      referralCode: generateReferralCode()
    };
    await set(ref(db, `users/${userId}`), defaultData);
    return defaultData;
  }
}

async function saveUserData(data) {
  await update(ref(db, `users/${userId}`), data);
}

async function updateUI() {
  const data = await getUserData();
  document.getElementById("balanceVal").innerText = data.balance.toFixed(2);
  document.getElementById("viewsVal").innerText = data.views;
  document.getElementById("refCountVal").innerText = data.refCount;
  document.getElementById("withdrawnVal").innerText = data.totalWithdrawn.toFixed(2);
}

// üîπ Watch Ad & Earn
window.watchAd = async function() {
  const watchBtn = document.getElementById('watchBtn');
  const countdownEl = document.getElementById('countdown');
  watchBtn.disabled = true;
  watchBtn.classList.add('muted');
  countdownEl.innerText = `‚è≥ Please wait ${AD_DURATION} seconds...`;

  try { if (typeof window.show_9777736 === "function") { window.show_9777736(); } } catch (e) {}

  let remaining = AD_DURATION;
  adTimer = setInterval(async () => {
    remaining--;
    countdownEl.innerText = `‚è≥ Please wait ${remaining} seconds...`;
    if (remaining <= 0) {
      clearInterval(adTimer);
      const data = await getUserData();
      data.balance += REWARD;
      data.views += 1;
      await saveUserData(data);
      countdownEl.innerText = `üéâ You earned ${REWARD.toFixed(2)} BDT!`;
      document.getElementById('coinSound').play().catch(() => {});
      watchBtn.disabled = false;
      watchBtn.classList.remove('muted');
      updateUI();
    }
  }, 1000);
};

// üîπ Withdraw Section
window.showWithdraw = function() {
  document.getElementById("withdraw-section").classList.remove("hidden");
  document.getElementById("ad-section").classList.add("hidden");
  document.getElementById("referral-section").classList.add("hidden");
};

window.calculateBDT = function() {
  const amount = parseFloat(document.getElementById("balanceAmount").value) || 0;
  document.getElementById("bdtValue").innerText = `You will get: ${amount.toFixed(2)} BDT`;
};

window.submitWithdraw = async function() {
  const method = document.getElementById("method").value;
  const amount = parseFloat(document.getElementById("balanceAmount").value);
  const account = document.getElementById("accountNumber").value.trim();
  const data = await getUserData();
  if (isNaN(amount) || amount < MIN_WITHDRAW) return alert(`Minimum withdraw is ${MIN_WITHDRAW} BDT.`);
  if (!account || account.length < 6) return alert("Please enter a valid account number.");
  if (amount > data.balance) return alert("You don't have enough balance.");
  if (data.refCount < MIN_REF_FOR_WITHDRAW) return alert(`You need at least ${MIN_REF_FOR_WITHDRAW} referrals.`);

  data.balance -= amount;
  data.totalWithdrawn += amount;
  await saveUserData(data);
  document.getElementById("withdraw-section").innerHTML = `
    <h3>‚úÖ Withdraw request submitted!</h3>
    <p>Method: ${method.toUpperCase()}</p>
    <p>Amount: ${amount.toFixed(2)} BDT</p>
    <p>Account: ${account}</p>
    <p>We will process your request soon.</p>
    <button class="btn back-btn" onclick="goBack()">üîô Back</button>`;
  updateUI();
};

// üîπ Referral System
window.showReferral = async function() {
  document.getElementById("referral-section").classList.remove("hidden");
  document.getElementById("withdraw-section").classList.add("hidden");
  document.getElementById("ad-section").classList.add("hidden");

  const data = await getUserData();
  document.getElementById("refLink").innerText = `https://t.me/ads25_income_bot?start=${data.referralCode}`;
};

window.copyReferral = function() {
  const ref = document.getElementById("refLink").innerText;
  navigator.clipboard.writeText(ref).then(() => alert("Referral link copied!"));
};

window.claimReferralBonus = async function() {
  const code = document.getElementById("claimCode").value.trim();
  const data = await getUserData();
  if (!code) return alert("Please enter referral code.");
  if (code === data.referralCode) return alert("You cannot use your own referral code.");
  if (data.claimedReferrals.includes(code)) return alert("Already claimed from this code.");

  // üîç Find the user who owns this referral code
  const dbRef = ref(db, "users");
  const q = query(dbRef, orderByChild("referralCode"), equalTo(code));
  const snapshot = await get(q);

  if (!snapshot.exists()) {
    return alert("Invalid referral code.");
  }

  // Update both users
  const referrerId = Object.keys(snapshot.val())[0];
  const referrerData = snapshot.val()[referrerId];

  // Update referrer
  referrerData.balance = (referrerData.balance || 0) + REF_BONUS;
  referrerData.refCount = (referrerData.refCount || 0) + 1;
  await update(ref(db, `users/${referrerId}`), referrerData);

  // Update current user
  data.claimedReferrals.push(code);
  await saveUserData(data);

  alert(`üéâ You successfully supported your referrer! They earned ${REF_BONUS} BDT.`);
  updateUI();
};

// üîπ Go Back
window.goBack = function() {
  document.getElementById("withdraw-section").classList.add("hidden");
  document.getElementById("referral-section").classList.add("hidden");
  document.getElementById("ad-section").classList.remove("hidden");
  updateUI();
};

// üîπ Notice Overlay
window.showNotice = function() { document.getElementById("noticeOverlay").style.display = "flex"; };
window.closeNotice = function() { document.getElementById("noticeOverlay").style.display = "none"; };
window.onload = function() { setTimeout(showNotice, 2000); updateUI(); };
</script>

<!-- üåà Dark Blue-Purple Theme -->
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:linear-gradient(135deg,#1e1b4b,#312e81,#3730a3);color:#fff;min-height:100vh;display:flex;justify-content:center;padding:20px;}
.container{width:100%;max-width:480px;display:flex;flex-direction:column;gap:20px;animation:fadeIn 1s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.card{background:rgba(255,255,255,0.08);border-radius:16px;padding:22px;backdrop-filter:blur(12px);box-shadow:0 0 20px rgba(79,70,229,0.3);}
.card:hover{transform:translateY(-3px);box-shadow:0 0 30px rgba(99,102,241,0.5);}
.profile{display:flex;align-items:center;gap:15px;}
.profile img{width:70px;height:70px;border-radius:50%;border:3px solid #818cf8;box-shadow:0 0 15px rgba(99,102,241,0.6);}
.stats{display:flex;justify-content:space-between;gap:10px;}
.stat-box{flex:1;background:rgba(255,255,255,0.1);padding:12px;border-radius:12px;text-align:center;border:1px solid rgba(255,255,255,0.15);}
.stat-box h4{color:#c7d2fe;}
.stat-box p{font-weight:bold;}
.btn{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(90deg,#6366f1,#4f46e5);color:#fff;font-weight:600;cursor:pointer;margin-top:10px;transition:.3s;}
.btn:hover{transform:scale(1.03);box-shadow:0 0 20px rgba(99,102,241,0.6);}
.back-btn{background:linear-gradient(90deg,#6b7280,#4b5563);}
input,select{width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;}
.hidden{display:none;}
#noticeOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:999;}
.notice-card{background:rgba(255,255,255,0.1);color:#fff;width:90%;max-width:380px;padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 0 25px rgba(99,102,241,0.6);position:relative;}
.close-btn{position:absolute;top:10px;right:15px;font-size:25px;color:#fff;cursor:pointer;transition:0.3s;}
.close-btn:hover{color:#f87171;transform:scale(1.2);}
</style>
</head>
<body>

<div class="container">
<h2 style="text-align:center;">SMART EARN</h2>

<div class="card profile">
<img id="user-photo" src="https://telegram.org/img/t_logo.png">
<div><div id="user-name">Loading...</div></div>
</div>

<div class="stats">
<div class="stat-box"><h4>Balance</h4><p id="balanceVal">0</p></div>
<div class="stat-box"><h4>Ads Watched</h4><p id="viewsVal">0</p></div>
</div>

<div class="stats">
<div class="stat-box"><h4>Referrals</h4><p id="refCountVal">0</p></div>
<div class="stat-box"><h4>Total Withdrawn</h4><p id="withdrawnVal">0</p></div>
</div>

<div class="card" id="ad-section">
<p>You will get 5 Tk for each ad you watch.</p>
<p>You will get 50 Tk for each referral</p>
<button class="btn" id="watchBtn" onclick="watchAd()">üé¨ Watch Ad</button>
<p id="countdown"></p>
</div>

<div class="card">
<button class="btn" onclick="showWithdraw()">üí∏ Withdraw</button>
<button class="btn" onclick="showReferral()">ü§ù Refer</button>
</div>

<div class="card hidden" id="withdraw-section">
<h3>Withdraw Balance</h3>
<select id="method">
<option value="bkash">Bkash</option>
<option value="nagad">Nagad</option>
</select>
<input type="number" id="balanceAmount" placeholder="Enter Amount" oninput="calculateBDT()">
<p id="bdtValue">You will get: 0 BDT</p>
<p style="font-size:13px;color:#f87171;">‚ö†Ô∏è Minimum Withdraw: 2000 BDT & 10 Referrals Required</p>
<input type="text" id="accountNumber" placeholder="Enter your account number">
<button class="btn" onclick="submitWithdraw()">Submit</button>
<button class="btn back-btn" onclick="goBack()">üîô Back</button>
</div>

<div class="card hidden" id="referral-section">
<h3>Your Referral Link</h3>
<p id="refLink">Loading...</p>
<button class="btn" onclick="copyReferral()">‚òï Copy</button>
<div style="margin-top:15px;">
<h4>Claim Bonus Using Referral Code</h4>
<input type="text" id="claimCode" placeholder="Enter referral code">
<button class="btn" onclick="claimReferralBonus()">Claim Bonus</button>
</div>
<button class="btn back-btn" onclick="goBack()">üîô Back</button>
</div>
</div>

<audio id="coinSound"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>

<div id="noticeOverlay">
  <div class="notice-card">
    <span class="close-btn" onclick="closeNotice()">‚úñ</span>
    <p>‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ ‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‚ù§Ô∏è<br><br>
    ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ Telegram ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶® ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶™‡ßá‡¶§‡ßáüëá</p>
    <a href="https://t.me/ads25_income_channel" class="btn" target="_blank">Join Channel</a>
  </div>
</div>

</body>
</html>
